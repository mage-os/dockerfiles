FROM graycore/magento-php:8.1-cli-alpine-v6.0.0-alpha.4

# REPLACE ABOVE WITH PHP-CLI IMAGE GENERATED BY MAGE2DOCKER
COPY ./patches/patches.json /home/patches.json

RUN composer create-project --no-interaction --no-install  --repository-url=https://mirror.mage-os.org/ magento/project-community-edition:2.4.4 /var/www/html && \
    composer require --no-interaction --no-install cweagans/composer-patches && \
    composer config --no-interaction extra.patches-file /home/patches.json && \
    composer config --no-interaction extra.composer-exit-on-patch-failure true && \
    composer config --no-interaction allow-plugins.cweagans/composer-patches true && \
    composer config --no-interaction allow-plugins.dealerdirect/phpcodesniffer-composer-installer true && \
    composer config --no-interaction allow-plugins.laminas/laminas-dependency-plugin true && \
    composer config --no-interaction allow-plugins.magento/* true && \
    composer install --no-interaction && \
    rm -rf /var/www/html/vendor/magento/magento2-base && \
    rm -rf /var/www/html/vendor/magento/**/**/Test && \ 
    rm -rf /var/www/html/dev/

COPY ./conf/config.php /var/www/html/app/etc/config.php

RUN php bin/magento setup:di:compile && \
    composer dump-autoload -o --classmap-authoritative && \
    php bin/magento setup:static-content:deploy -f  \
    --theme Magento/backend \
    --theme Magento/luma
